<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <title>Webby Mouse</title>
    <link rel="stylesheet" href="public/vendor/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="public/vendor/bootstrap-material-design/dist/css/ripples.min.css">
    <link rel="stylesheet" href="public/vendor/bootstrap-material-design/dist/css/material.min.css">
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      .touchpad {position: fixed; display: block; width: 100%; height: calc(100% - 50px);};
    </style>
    <!-- build:css style/app.min.css -->
    <link rel="stylesheet" href="public/style/main.css">
    <!-- endbuild -->
    <!-- <link rel="localization" href="locales/manifest.json"> -->

    <!-- build:js js/app.min.js -->
    <!-- <script defer src="vendor/l20n/l20n.min.js"></script> -->
    <!-- endbuild -->
  </head>
  <body>
    <header id="header" class="navbar navbar-fixed-top shadow-z-3">
      <a id="title" class="navbar-brand" href="#" data-l10n-id="projectName">Webby Mouse</a>
      <ul class="nav navbar-nav pull-left">
        <!--li class="active"><a href="#mouse">Mouse</a></li-->
        <!--li><a href="#air">AirMouse</a></li-->
      </ul>
    </header>
    <div id="touchpad" class="touchpad"></div>
    <script src="/public/vendor/jquery/dist/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/public/vendor/hammerjs/hammer.min.js"></script>
    <script>
      var touchElem = document.getElementById('touchpad');
      var title = document.getElementById('title');
      var socket = io();
      var delta = null;
      var moving = false;
      var isAirMouseMode = false;

      var pos = {x: 0, y: 0, cmd: null};
      var orient = {alpha: 0, beta: 0, gamma: 0};
      /**
       * pass `pos` object to socket.emit('mouse', pos) function
       *
       * {Object} pos
       * {integer} pos.x mouse x offset
       * {integer} pos.y mouse y offset
       * {string} pos.cmd key command or mouse click (not implemented yet)
       */
      var emitMouse = function(x, y, cmd) {
        pos.x = x;
        pos.y = y;
        pos.cmd = cmd;

        socket.emit('mouse', pos);
      };

      // receive msg
      //socket.on('mouse', function(msg) {
        //console.log(msg);
        //console.info(msg.x + ',' + msg.y);
      //});

      /* Touchpad mode */
      var handlePan = function(eventName, e) {
        if (e.type == eventName + 'start') {
          delta = null;
          moving = true;
          console.log('start ' + eventName);
          emitMouse(0, 0, eventName + 'start');
        }
        if (e.type == eventName + 'end') {
          delta = null;
          moving = false;
          emitMouse(0, 0, eventName + 'end');
        }
        if (moving && delta != null) {
          emitMouse(e.deltaX - delta.x, e.deltaY - delta.y, eventName);
        }
        delta = {x: e.deltaX, y: e.deltaY};
      };

      var mc = new Hammer.Manager(touchElem);
      mc.add(new Hammer.Pan({ event: 'move', threshold: 0, pointers: 1, direction: Hammer.DIRECTION_ALL }));
      mc.add(new Hammer.Pan({ event: 'scroll', threshold: 0, pointers: 2, direction: Hammer.DIRECTION_ALL }));
      mc.add(new Hammer.Pan({ event: 'drag', threshold: 0, pointers: 3, direction: Hammer.DIRECTION_ALL }));
      mc.add(new Hammer.Tap({ event: 'click', pointers: 1 }));
      mc.add(new Hammer.Tap({ event: 'rightclick', pointers: 2 }));

      mc.on('movestart moveend moveup movedown moveleft moveright', function(e) {
        handlePan('move', e);
      });
      mc.on('scrollstart scrollend scrollup scrolldown scrollleft scrollright', function(e) {
        handlePan('scroll', e);
      });
      mc.on('dragstart dragend dragup dragdown dragleft dragright', function(e) {
        handlePan('drag', e);
      });
      mc.on('click', function(e) {
        console.info('click');
        emitMouse(0, 0, 'click');
      });
      mc.on('rightclick', function(e) {
        console.info('rightclick');
        emitMouse(0, 0, 'rightclick');
      });
      
      /* AirMousese mode */
      mc.add(new Hammer.Press({ event: 'press', threshold: 5, pointers: 1, time: 500}));
      mc.add(new Hammer.Press({ event: 'pressup', threshold: 5, pointers: 1, time: 500}));

      mc.on('press', function(e) {
        console.info('air mouse');
        window.addEventListener('deviceorientation', handleOrientation);
      });

      mc.on('pressup', function(e) {
        console.info('air mouse disabled');
        // reset default values
        window.removeEventListener('deviceorientation', handleOrientation);
        isAirMouseMode = false;
        orient.alpha = 0;
        orient.beta = 0;
        orient.gamma = 0;
      });

      // Because we don't want to have the device upside down
      // We constrain the x value to the range [-90,90]
      var Rectifier = function Rectifier(x) {
        if (x >  90) {x =  90};
        if (x < -90) {x = -90};
        return x;
      };

      var handleOrientation = function handleOrientation(event) {
        if (!isAirMouseMode) {
          orient.beta = event.beta;//Rectifier(event.alpha);
          orient.gamma = event.gamma;
          isAirMouseMode = true;
        } else {
          var x = event.beta;//Rectifier(event.alpha);  // In degree in the range [-180,180]
          var y = event.gamma; // In degree in the range [-90,90]
          title.innerHTML = 'x:' + event.beta + 'y:' + event.gamma + 'z:' + event.alpha;
          emitMouse(x - orient.beta, y - orient.gamma, 'air');
        }
      }
    </script>
  </body>
</html>

